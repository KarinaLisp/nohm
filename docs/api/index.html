<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Home - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="NohmClass.html">NohmClass</a><ul class='methods'><li data-type='method'><a href="NohmClass.html#factory">factory</a></li><li data-type='method'><a href="NohmClass.html#getModels">getModels</a></li><li data-type='method'><a href="NohmClass.html#middleware">middleware</a></li><li data-type='method'><a href="NohmClass.html#model">model</a></li><li data-type='method'><a href="NohmClass.html#purgeDb">purgeDb</a></li><li data-type='method'><a href="NohmClass.html#register">register</a></li><li data-type='method'><a href="NohmClass.html#setClient">setClient</a></li><li data-type='method'><a href="NohmClass.html#setPrefix">setPrefix</a></li></ul></li><li><a href="NohmErrors.LinkError.html">LinkError</a></li><li><a href="NohmErrors.ValidationError.html">ValidationError</a></li><li><a href="NohmModel.html">NohmModel</a><ul class='methods'><li data-type='method'><a href="NohmModel.html#allProperties">allProperties</a></li><li data-type='method'><a href="NohmModel.html#belongsTo">belongsTo</a></li><li data-type='method'><a href="NohmModel.html#exists">exists</a></li><li data-type='method'><a href="NohmModel.html#find">find</a></li><li data-type='method'><a href="NohmModel.html#getAll">getAll</a></li><li data-type='method'><a href="NohmModel.html#getDefinitions">getDefinitions</a></li><li data-type='method'><a href="NohmModel.html#link">link</a></li><li data-type='method'><a href="NohmModel.html#load">load</a></li><li data-type='method'><a href="NohmModel.html#numLinks">numLinks</a></li><li data-type='method'><a href="NohmModel.html#property">property</a></li><li data-type='method'><a href="NohmModel.html#propertyDiff">propertyDiff</a></li><li data-type='method'><a href="NohmModel.html#propertyReset">propertyReset</a></li><li data-type='method'><a href="NohmModel.html#remove">remove</a></li><li data-type='method'><a href="NohmModel.html#save">save</a></li><li data-type='method'><a href="NohmModel.html#setUniqueIds">setUniqueIds</a></li><li data-type='method'><a href="NohmModel.html#sort">sort</a></li><li data-type='method'><a href="NohmModel.html#subscribe">subscribe</a></li><li data-type='method'><a href="NohmModel.html#subscribeOnce">subscribeOnce</a></li><li data-type='method'><a href="NohmModel.html#unlink">unlink</a></li><li data-type='method'><a href="NohmModel.html#unlinkAll">unlinkAll</a></li><li data-type='method'><a href="NohmModel.html#unsubscribeEvent">unsubscribeEvent</a></li><li data-type='method'><a href="NohmModel.html#validate">validate</a></li></ul></li><li><a href="NohmStaticModel.html">NohmStaticModel</a><ul class='methods'><li data-type='method'><a href="NohmStaticModel.html#.find">find</a></li><li data-type='method'><a href="NohmStaticModel.html#..findAndLoad">.findAndLoad</a></li><li data-type='method'><a href="NohmStaticModel.html#..load">.load</a></li><li data-type='method'><a href="NohmStaticModel.html#..loadMany">.loadMany</a></li><li data-type='method'><a href="NohmStaticModel.html#.remove">remove</a></li><li data-type='method'><a href="NohmStaticModel.html#..sort">.sort</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Nohm.html">Nohm</a><ul class='methods'><li data-type='method'><a href="Nohm.html#.MiddlewareCallback">MiddlewareCallback</a></li></ul></li><li><a href="NohmErrors.html">NohmErrors</a></li><li><a href="Validators.html">Validators</a><ul class='methods'><li data-type='method'><a href="Validators.html#.alphanumeric">alphanumeric</a></li><li data-type='method'><a href="Validators.html#.date">date</a></li><li data-type='method'><a href="Validators.html#.dateISO">dateISO</a></li><li data-type='method'><a href="Validators.html#.digits">digits</a></li><li data-type='method'><a href="Validators.html#.email">email</a></li><li data-type='method'><a href="Validators.html#.length">length</a></li><li data-type='method'><a href="Validators.html#.minMax">minMax</a></li><li data-type='method'><a href="Validators.html#.notEmpty">notEmpty</a></li><li data-type='method'><a href="Validators.html#.number">number</a></li><li data-type='method'><a href="Validators.html#.numberEU">numberEU</a></li><li data-type='method'><a href="Validators.html#.numberSI">numberSI</a></li><li data-type='method'><a href="Validators.html#.numberUS">numberUS</a></li><li data-type='method'><a href="Validators.html#.regexp">regexp</a></li><li data-type='method'><a href="Validators.html#.url">url</a></li></ul></li></ul>
</nav>

<div id="main">
    

    



    









    


    <section class="readme">
        <article><h1>Nohm</h1><p><a href="https://travis-ci.org/maritz/nohm"><img src="https://travis-ci.org/maritz/nohm.svg?branch=master" alt="Build Status"></a>
<a href="https://david-dm.org/maritz/nohm"><img src="https://david-dm.org/maritz/nohm.svg" alt="Dependency Status"></a>
<a href="https://snyk.io/test/github/maritz/nohm"><img src="https://snyk.io/test/github/maritz/nohm/badge.svg" alt="Known Vulnerabilities (Snyk)"></a>
<a href="https://coveralls.io/github/maritz/nohm?branch=master"><img src="https://coveralls.io/repos/github/maritz/nohm/badge.png?branch=master" alt="Coverage Status"></a></p>
<h2>Description</h2><p>Nohm is an object relational mapper (ORM) written for node.js and redis written in Typescript.</p>
<h3>Features</h3><ul>
<li><strong>Standard ORM features (validate, store, search, sort, link/unlink, delete)</strong></li>
<li><strong>Share validations with browser.</strong><br>Allows using the same code for clien validations that is used for backend. Includes filtering which validations are shared.</li>
<li><strong>Subscribe to orm events (save, delete, link, unlink)</strong><br>With this you can do things like socket connections to get live updates from stored models.<br>Since it uses redis PUBSUB you can scale your node app and clients can connect to seperate node app instances but will still get the same live updates.</li>
<li><strong>Typescript typings</strong><br>nohm is written in Typescript and thus provides first-class typings for most things, including the option to type your model properties. This means if you use Typescript you don't have to remember every single property name of each model anymore, your IDE can tell you.</li>
<li><strong>Dynamic relations</strong><br>This is a double-edged sword. Usually ORMs describe relations statically and you have to do database changes before you can add new relations.<br>In nohm all relations are defined and used at run-time, since there are no schemas stored in the database.</li>
</ul>
<h2>Requirements</h2><ul>
<li>redis &gt;= 2.4</li>
</ul>
<h2>Documentation</h2><p><a href="https://maritz.github.io/nohm/index.html">v2 documentation</a></p>
<p><a href="https://maritz.github.io/nohm/api/index.html">API docs</a></p>
<p><a href="http://maritz.github.com/nohm/">v1 documentation</a></p>
<p><a href="https://github.com/maritz/nohm/blob/master/CHANGELOG.md#v200-currently-in-alpha">v1 to v2 migration guide</a></p>
<h2>Example</h2><p>The <a href="https://github.com/maritz/nohm/tree/master/examples/rest-user-server">examples/rest-user-server</a> is running as a demo on <a href="https://nohm-example.maritz.space">https://nohm-example.maritz.space</a>. It showcases most features on a basic level, including the shared validation and PubSub.</p>
<details>

<summary>Example ES6 code (click to expand)</summary>

<code>javascript
import { Nohm, NohmModel, ValidationError } from 'nohm';
// or if your environment does not support module import
// const NohmModule = require('nohm'); // access NohmModule.Nohm, NohmModule.NohmModel and NohmModule.ValidationError

// This is the parent object where you set redis connection, create your models and some other configuration stuff
const nohm = Nohm;

nohm.setPrefix('example'); // This prefixes all redis keys. By default the prefix is &quot;nohm&quot;, you probably want to change it to your applications name or something similar

// This is a class that you can extend to create nohm models. Not needed when using nohm.model()
const Model = NohmModel;

const existingCountries = ['Narnia', 'Gondor', 'Tatooine'];

// Using ES6 classes here, but you could also use the old nohm.model definition
class UserModel extends Model {
  getCountryFlag() {
    return `http://example.com/flag_${this.property('country')}.png`;
  }
}
// Define the required static properties
UserModel.modelName = 'User';
UserModel.definitions = {
  email: {
    type: 'string',
    unique: true,
    validations: ['email'],
  },
  country: {
    type: 'string',
    defaultValue: 'Narnia',
    index: true,
    validations: [
      // the function name will be part of the validation error messages, so for this it would be &quot;custom_checkCountryExists&quot;
      async function checkCountryExists(value) {
        // needs to return a promise that resolves to a bool - async functions take care of the promise part
        return existingCountries.includes(value);
      },
      {
        name: 'length',
        options: { min: 3 },
      },
    ],
  },
  visits: {
    type: function incrVisitsBy(value, key, old) {
      // arguments are always string here since they come from redis.
      // in behaviours (type functions) you are responsible for making sure they return in the type you want them to be.
      return parseInt(old, 10) + parseInt(value, 10);
    },
    defaultValue: 0,
    index: true,
  },
};

// register our model in nohm and returns the resulting Class, do not use the UserModel directly!
const UserModelClass = nohm.register(UserModel);

const redis = require('redis').createClient();
// wait for redis to connect, otherwise we might try to write to a non-existant redis server
redis.on('connect', async () =&gt; {
  nohm.setClient(redis);

  // factory returns a promise, resolving to a fresh instance (or a loaded one if id is provided, see below)
  const user = await nohm.factory('User');

  // set some properties
  user.property({
    email: 'mark13@example.com',
    country: 'Gondor',
    visits: 1,
  });

  try {
    await user.save();
  } catch (err) {
    if (err instanceof ValidationError) {
      // validation failed
      for (const key in err.errors) {
        const failures = err.errors[key].join(`', '`);
        console.log(
          `Validation of property '${key}' failed in these validators: '${failures}'.`,
        );

        // in a real app you'd probably do something with the validation errors (like make an object for the client)
        // and then return or rethrow some other error
      }
    }
    // rethrow because we didn't recover from the error.
    throw err;
  }
  console.log(`Saved user with id ${user.id}`);

  const id = user.id;

  // somewhere else we could then load the user again
  const loadedUser = await UserModelClass.load(id); // this will throw an error if the user cannot be found

  // alternatively you can use nohm.factory('User', id)

  console.log(`User loaded. His properties are %j`, loadedUser.allProperties());
  const newVisits = loadedUser.property('visits', 20);
  console.log(`User vists set to ${newVisits}.`); // Spoiler: it's 21

  // or find users by country
  const gondorians = await UserModelClass.findAndLoad({
    country: 'Gondor',
  });
  console.log(
    `Here are all users from Gondor: %j`,
    gondorians.map((u) =&gt; u.property('email')),
  );

  await loadedUser.remove();
  console.log(`User deleted from database.`);
});</code>

</details>

<details>

<summary>Example Typescript code (click to expand)</summary>

<code>typescript
import { Nohm, NohmModel, TTypedDefinitions } from 'nohm';

// We're gonna assume the basics are clear and the connection is set up etc. - look at the ES6 example otherwise.
// This example highlights some of the typing capabilities in nohm.

interface IUserProperties {
  email: string;
  visits: number;
}

class UserModel extends NohmModel&lt;IUserProperties&gt; {
  public static modelName = 'User';

  protected static definitions: TTypedDefinitions&lt;IUserProperties&gt; = {
    // because of the TTypedDefinitions we can only define properties keys here that match our interface keys
    // the structure of the definitions is also typed
    email: {
      type: 'string', // the type value is currently not checked. If you put a wrong type here, no compile error will appear.
      unique: true,
      validations: ['email'],
    },
    visits: {
      defaultValue: 0,
      index: true,
      type: function incrVisitsBy(value, _key, old): number {
        return old + value; // TS Error: arguments are all strings, not assignable to number
      },
    },
  };

  public getVisitsAsString(): string {
    return this.property('visits'); // TS Error: visits is number and thus not asignable to string
  }

  public static async loadTyped(id: string): Promise&lt;UserModel&gt; {
    // see main() below for explanation
    return userModelStatic.load&lt;UserModel&gt;(id);
  }
}

const userModelStatic = nohm.register(UserModel);

async function main() {
  // currently you still have to pass the generic if you want typing for class methods
  const user = await userModelStatic.load&lt;UserModel&gt;('some id');
  // you can use the above defined loadTyped method to work around that.

  const props = user.allProperties();
  props.email; // string
  props.id; // any
  props.visits; // number
  props.foo; // TS Error: Property foo does not exist
  user.getVisitsAsString(); // string
}

main();</code>

</details>

<h3>More detailed examples</h3><ul>
<li><a href="https://github.com/maritz/nohm/tree/master/examples/rest-user-server">nohm/examples/rest-user-server</a></li>
<li><a href="https://github.com/yuchi/Beauvoir">Beauvoir</a> Simple project management app - by yuchi (uses node v0.6 - very old)</li>
</ul>
<p>Do you have code that should/could be listed here? Message me!</p>
<h2>Add it to your project</h2><pre class="prettyprint source"><code>npm install --save nohm</code></pre><h2>Debug</h2><p>Nohm uses the <a href="https://github.com/visionmedia/debug">debug</a> module under the namespace &quot;nohm&quot;. To see detailed debug logging set the environment variable DEBUG accordingly:</p>
<pre class="prettyprint source"><code>DEBUG=&quot;nohm:*&quot; node yourApp.js</code></pre><p>Available submodule debug namespaces are <code>nohm:index</code>, <code>nohm:model</code>, <code>nohm:middleware</code>, <code>nohm:pubSub</code> and <code>nohm:idGenerator</code>.</p>
<h2>Developing nohm</h2><p>If you want to make changes to nohm, you can fork or clone it. Then install the dependencies:</p>
<pre class="prettyprint source"><code>npm install</code></pre><p>and run the development scripts (compile &amp; watch &amp; tests):</p>
<pre class="prettyprint source"><code>npm run dev</code></pre><p>When submitting PRs, please make sure that you run the linter and that everything still builds fine. The CI will catch these problems, but it's better to check locally first.<br>The easiest way to do that is to run the <code>prepublishOnly</code> script:</p>
<pre class="prettyprint source"><code>npm run prepublishOnly</code></pre><h2>Running tests seperately</h2><p>Build the javascript files:</p>
<pre class="prettyprint source"><code>npm run build</code></pre><p>Then run the tests:</p>
<pre class="prettyprint source"><code>npm run test</code></pre><p>This requires a running redis server. (you can configure host/port with the command line arguments --redis-host 1.1.1.1 --redis-port 1234)</p>
<p><strong>WARNING</strong>: The tests also create a lot of keys in your database that look something like this:</p>
<pre class="prettyprint source"><code>nohmtests:something:something</code></pre><p>After the tests have run all keys that match the pattern nohmtests:* are deleted!
You can prevent this by passing --no-cleanup (which will leave hundreds or thousands of test keys in your database).
You may also change the prefix (&quot;nohmtests&quot;) part doing something like</p>
<pre class="prettyprint source"><code>node test/tests.js --nohm-prefix YourNewPrefix</code></pre><p>Now the keys will look like this:</p>
<pre class="prettyprint source"><code>YourNewPrefix:something:something</code></pre><p>Do note that the tests intentionally log out some warnings and errors. However these have (blue) log lines before them, announcing them. Any warnings/errors that do not have these announcements are actual problems.</p>
<h2>Note about npm audit warnings</h2><p>Currently npm audit detects 5 minor vulnerabilities in nohm, all of which are under nodeunit -&gt; tap.</p>
<p>nodeunit is only installed when you install the dev dependencies (aka. <code>npm install</code> in a checked out version of this repo for example).</p>
<p>In addition to that the tap reporter of nodeunit is not used at all.</p>
<p>Thus these vulnerabilities do not affect nohm. There is however an <a href="https://github.com/maritz/nohm/issues/116">open task</a> to switch away from nodeunit anyways, so these warnings will hopefully go away soon™.</p></article>
    </section>






</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>